<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0" />
		<title>详情</title>
		<link rel="stylesheet" href="assest/mui/css/mui.css" />
		<link rel="stylesheet" href="css/goods-detail.css" />
	</head>

	<body>
		<div id="app" class="mui-content">
			<div class="top">
				<img :src="goodsImg" />
			</div>
			<div class="main-content">
				<article>
					{{goodsName}}
				</article>
				<div class="mian-content-price">
					<span class="price">
						￥{{goodsPrice}}
					</span>
					<button @click="addToCart(goodsId)" class="mui-btn mui-btn-green">加入购物车</button>
				</div>
			</div>
			<div class="main-content-desc">
				{{goodsDesc}}
			</div>
			<div @click="goToCart()" class="shopping-cart-container">
				<span v-if="goodsNum != 0" class="mui-badge mui-badge-danger circle-num">{{goodsNum}}</span>
				<img src="img/购物车.png" class="shopping-cart" />
			</div>
		</div>
		<script type="text/javascript" src="assest/mui/js/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="assest/mui/js/mui.min.js"></script>
		<script type="text/javascript" src="js/vue.min.js"></script>
		<script type="text/javascript" src="js/global.js" ></script>
		<script type="text/javascript" src="js/sha1.js"></script>
		<script type="text/javascript">
			var app = new Vue({
				el:'#app',
				data:{
					token:'',
					transfer_key:'',
					goodsName:'',
					goodsImg:'',
                    goodsPrice:'',
                    goodsDesc:'',
					goodsId:'',
					goodsNum:0
				},
				methods:{
                    /**
					 * 加入购物车
                     * @param goodsId
                     */
				    addToCart:function(goodsId) {
				        var goods = {};
				        goods.goods_id = goodsId;
				        goods.number = 1;
				        console.log(goods);
                        $.ajax({
                            type:"post",
                            url:" http://qpg.vlusi.com/api/api.php",
                            async:true,
                            dataType:'json',
                            data:{
                                act:'add_to_cart',
                                token:app.token,
                                goods:goods,
                                signature:SHA2(`act=add_to_cart&goods=${goods}&token=${app.token}${app.transfer_key}`)
                            },
                            success:function(data) {
                                if(data.code == 200) {
									mui.toast('加入购物车成功');
									//重新获取购物车数据
									transformParams(getCartList);
                                }
                                else {
                                    mui.toast('加入购车失败!');
                                }
                            },
                            error:function() {
                                mui.toast('服务器异常!');
                            }
                        });
					},
                    goToCart:function () {
                        var u = navigator.userAgent;
                        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
                        var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
                        if (isAndroid == true) {
                            android.goToCart();
                        } else {
                            goToCart()
                        }

                    }
				}
			});
            /**
			 * 获取商品详情
             */
			function getGoodsDetail(param) {
			    app.token = param.token;
			    app.transfer_key = param.transfer_key;
                $.ajax({
                    type:"post",
                    url:" http://qpg.vlusi.com/api/api.php",
                    async:true,
                    dataType:'json',
                    data:{
                        act:'search_goods_detail',
                        token:param.token,
						goods_id:param.goods_id,
                        signature:SHA2(`act=search_goods_detail&goods_id=${param.goods_id}&token=${param.token}${param.transfer_key}`)
                    },
                    success:function(data) {
                        if(data.code == 200) {
                            app.goodsDesc = data.data.goods_des;
                            app.goodsImg = data.data.goods_img;
                            app.goodsPrice = data.data.shop_price;
                            app.goodsId = data.data.goods_id;
                        	app.goodsName = data.data.goods_name;
                        }
                        else {
                            mui.toast('获取商品数据失败!');
                        }
                    },
                    error:function() {
						mui.toast('服务器异常!');
                    }
                });
            }

            /**
			 * 获取购车商品数量
             * @param param
             */
            function getCartList(param) {
                $.ajax({
                    type:"post",
                    url:" http://qpg.vlusi.com/api/api.php",
                    async:true,
                    dataType:'json',
                    data:{
                        act:'cart_list',
                        token:param.token,
                        supplier_id:param.supplier_id,
                        signature:SHA2(`act=cart_list&supplier_id=${param.supplier_id}&token=${param.token}${param.transfer_key}`)
                    },
                    success:function(data) {
                        if(data.code == 200) {
							app.goodsNum = data.data.total.goods_amount;
                        }
                        else {
                            mui.toast('获取购物车数据失败!');
                        }
                    },
                    error:function() {
                        mui.toast('服务器异常!');
                    }
                });
            }

            function goToCart() {
                mui.alert('去购物车');
			}
            $(function () {
                //获取商品详情
				transformParams(getGoodsDetail);
				//获取购物车中的数量
				transformParams(getCartList);
            })
		</script>
	</body>

</html>